<!DOCTYPE html>
<html lang="es">
<head>
  <title>Pizzel Ep. 100 - Floppy Edition</title>
  <link rel="stylesheet" href="https://cdn.simplecss.org/simple.min.css">

  <script type="module">
    const PARTICIPANTS = [
      "floppy_disk_collector",
      "pizza_slice_dreams",
      "retro_storage_sam",
      "pepperoni_pixel_party",
      "disk_drive_diva",
      "cheesy_tech_dreams",
      "vintage_media_maven",
      "pizza_underground_club",
      "magnetic_memory_mike",
      "margherita_madness",
      "legacy_data_dave",
      "deep_dish_explorer",
      "diskette_detective",
      "pizza_ninja_bytes",
      "analog_storage_alice",
      "crust_and_circuits",
      "floppy_90s_kid",
      "pizza_code_master",
      "digital_relic_hunter",
      "slice_of_tech_heaven"
    ];

    //const TARGET_HEIGHT = 874112;

    const HASH_WINDOW_SIZE = 16;

    document.addEventListener("DOMContentLoaded", async () => {
      const participantsOl = document.getElementById("participants");
      const goButton = document.getElementById("go");
      const targetHeightInput = document.getElementById("targetheight");

      PARTICIPANTS.forEach((participant) => {
        const li = document.createElement("li");
        li.textContent = participant;
        participantsOl.append(li);
      });

      let req = await fetch("https://blockchain.info/q/getblockcount?cors=true");
      const currentHeight = Number(await req.text());

      document.getElementById("currentheight").textContent = currentHeight;
      targetHeightInput.value = currentHeight;
      targetHeightInput.max = currentHeight;

      goButton.addEventListener("click", async () => {
        goButton.disabled = true;

        const targetHeight = Number(targetHeightInput.value);

        if (currentHeight >= targetHeight) {
          const req = await fetch(`https://blockchain.info/block-height/${targetHeight}?format=json&cors=true`);
          const blocks = await req.json();

          console.log(blocks);

          if (blocks.blocks.length === 1) {
            const hash = blocks.blocks[0].hash;
            const hashLeft = hash.substring(0, hash.length - HASH_WINDOW_SIZE);
            const hashRight = hash.substring(hash.length - HASH_WINDOW_SIZE);
            const hashRight10 = parseInt(hashRight, 16);
            const hashRightDiv = Math.round(hashRight10 / Math.pow(16, HASH_WINDOW_SIZE) * PARTICIPANTS.length);

            document.getElementById("hash").innerHTML = `${hashLeft}<mark>${hashRight}</mark>`;
            document.getElementById("subhash").textContent = hashRight;
            document.getElementById("subhash10").textContent = hashRight10.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            document.getElementById("subhashdiv").textContent = hashRightDiv;
            document.getElementById("winner").textContent = PARTICIPANTS[hashRightDiv - 1];
          }
        }

        goButton.disabled = false;
      });
    });
  </script>
</head>
<body>
  <header>
    <h1>Pizzel Ep. 100 - Floppy Edition üíæ</h1>
    <h2>Simulaci√≥n de Sorteo üéüÔ∏è</h2>
  </header>

  <p>
    Participantes:

    <ol id="participants"></ol>
  </p>

  <p>
    Bloque actual: <span id="currentheight">&hellip;</span>
  </p>

  <p>
    Bloque objectivo: <input type="number" id="targetheight" required></input> <button type="button" id="go">Dale!</button>
  </p>

  <p>
    Hash: <code id="hash"></code>
  </p>

  <p>
    Sub-Hash: <code id="subhash"></code>
  </p>

  <p>
    Sub-Hash (base 10): <span id="subhash10"></span>
  </p>

  <p>
    Sub-Hash &rarr; No. de Participantes: <span id="subhashdiv"></span>
  </p>

  <p>
    Ganador/a: <span id="winner"></span> üéâ
  </p>
</body>
