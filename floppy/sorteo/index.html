<!DOCTYPE html>
<html lang="es">
<head>
  <title>Pizzel Ep. 100 - Floppy Edition</title>
  <link rel="stylesheet" href="https://cdn.simplecss.org/simple.min.css">

  <script type="module">
    const PARTICIPANTS = [
      "adventure_pixie23",
      "wanderlust_mike",
      "coffee_ninja_87",
      "urban_explorer_sam",
      "fitness_guru_luna",
      "foodie_dreams_katie",
      "travel_bug_alex",
      "sunset_chaser_emma",
      "tech_wizard_jay",
      "nature_lover_rose",
      "fitness_freak_max",
      "music_maven_charlie",
      "book_worm_emily",
      "art_soul_sophia",
      "digital_nomad_ryan",
      "vintage_vibes_lily",
      "sneaker_collector_jack",
      "plant_parent_aria",
      "workout_warrior_zoe",
      "music_mood_oliver"
    ];

    //const TARGET_HEIGHT = 874112;

    const HASH_WINDOW_SIZE = 16;

    document.addEventListener("DOMContentLoaded", async () => {
      const participantsUl = document.getElementById("participants");
      const goButton = document.getElementById("go");
      const targetHeightInput = document.getElementById("targetheight");

      PARTICIPANTS.forEach((participant) => {
        const li = document.createElement("li");
        li.textContent = participant;
        participantsUl.append(li);
      });

      let req = await fetch("https://blockchain.info/q/getblockcount?cors=true");
      const currentHeight = Number(await req.text());

      document.getElementById("currentheight").textContent = currentHeight;
      targetHeightInput.value = currentHeight;

      goButton.addEventListener("click", async () => {
        goButton.disabled = true;

        const targetHeight = Number(targetHeightInput.value);

        if (currentHeight >= targetHeight) {
          const req = await fetch(`https://blockchain.info/block-height/${targetHeight}?format=json&cors=true`);
          const blocks = await req.json();

          console.log(blocks);

          if (blocks.blocks.length === 1) {
            const hash = blocks.blocks[0].hash;
            const hashLeft = hash.substring(0, hash.length - HASH_WINDOW_SIZE);
            const hashRight = hash.substring(hash.length - HASH_WINDOW_SIZE);
            const hashRight10 = parseInt(hashRight, 16);
            const hashRightDiv = Math.round(hashRight10 / Math.pow(16, HASH_WINDOW_SIZE) * PARTICIPANTS.length);

            document.getElementById("hash").innerHTML = `${hashLeft}<mark>${hashRight}</mark>`;
            document.getElementById("subhash").textContent = hashRight;
            document.getElementById("subhash10").textContent = hashRight10;
            document.getElementById("subhashdiv").textContent = hashRightDiv;
            document.getElementById("winner").textContent = PARTICIPANTS[hashRightDiv];
          }
        }

        goButton.disabled = false;
      });
    });
  </script>
</head>
<body>
  <header>
    <h1>Pizzel Ep. 100 - Floppy Edition üíæ</h1>
    <h2>Simulaci√≥ de Sorteo üéüÔ∏è</h2>
  </header>

  <p>
    Participantes:

    <ul id="participants"></ul>
  </p>

  <p>
    Bloque actual: <span id="currentheight">&hellip;</span>
  </p>

  <p>
    Bloque objectivo: <input type="number" id="targetheight"></input> <button type="button" id="go">Dale!</button>
  </p>

  <p>
    Hash: <code id="hash"></code>
  </p>

  <p>
    Sub-Hash: <code id="subhash"></code>
  </p>

  <p>
    Sub-Hash (base 10): <span id="subhash10"></span>
  </p>

  <p>
    Sub-Hash / No. de Participates: <span id="subhashdiv"></span>
  </p>

  <p>
    Ganador/a: <span id="winner"></span> üéâ
  </p>
</body>
